{% extends "map/layout.html" %}
{% load static %}

{% block script %}
<script>
    var nextPageUrl = null; 

    function clearResults() {
        $("#results").html('');
        nextPageUrl = null;
    }

    function performSearch(url) {
        console.log("Search:", url);
        $("#loading").show();
        $("#search").prop('disabled', true);
    
        $.ajax({
            url: url,
            method: "GET",
            success: function(response) {
                console.log("Response:", response);
                $("#loading").hide();
    
                var keys = ['name', 'builder', 'address', 'city', 'state', 'postcode'];
                if (!nextPageUrl) {
                    $("#results").html('');
                    var table = $('<table class="table" id="results-table"></table>');
                    var thead = $('<thead></thead>');
                    var headerRow = $('<tr></tr>');
                    keys.forEach(function(key) {
                        headerRow.append('<th>' + key + '</th>');
                    });
    
                    thead.append(headerRow);
                    table.append(thead);
                    table.append('<tbody></tbody>');
                    $("#results").append(table);
                }
    
                var tbody = $('#results-table').find('tbody');
                response.results.forEach(function(item) {
                    var row = $('<tr></tr>');
                    keys.forEach(function(key) {
                        if (key === 'name') {
                            row.append('<td><a href="' + item.url + '" target="_blank">' + item[key] + '</a></td>');
                        } else {
                            row.append('<td>' + item[key] + '</td>');
                        }
                    });
                    tbody.append(row);
                });
    
                nextPageUrl = response.next;
                $("#search").prop('disabled', false);
            },
            error: function(error) {
                console.error("Error:", error);
                $("#results").html('<div class="mt-3">No results found.</div>');
                $("#loading").hide();
                $("#search").prop('disabled', false);
            }
        });
    }
    
    // search on button click or enter key
    $(document).ready(function() {
        $("#search").click(function() {
            clearResults();
            var query = $("#q").val();
            var url = "https://api.australianorgans.com.au/search/?q=" + query;
            performSearch(url);
        });
    
        $("#q").keydown(function(event) {
            if (event.key === 'Enter' && !$("#search").prop('disabled')) {
                clearResults();
                $("#search").click();
            }
        });
    
        // infinite scroll
        $(window).scroll(function() {
            var scrollPosition = $(window).scrollTop() + $(window).height();
            var nearBottom = $(document).height() - 10;
    
            if (scrollPosition >= nearBottom) {
                if (nextPageUrl && !$("#search").prop('disabled')) {
                    console.log("Loading more results...");
                    performSearch(nextPageUrl);
                }
            }
        });
    });    
</script>
{% endblock %}

{% block content %}
<h1 class="mt-5 mb-3">Australian Organs</h1>
<div class="row">
    <div class="col-md-10">
        <div class="form-group">
            <input type="text" class="form-control" name="q" id="q" placeholder="Enter search query" autofocus>
        </div>
        <small>Examples: St Matthew's Albury, Sydney Town Hall, Pierce Pipe Organs</small>
    </div>
    <div class="col-md-2">
        <div class="form-group">
            <button type="button" class="btn btn-primary" id="search">Search</button>
        </div>
    </div>
</div>
<div class="row">
    <div id="loading" class="text-center" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div class="col-md-12">
        <div id="results"></div>
    </div>
</div>
{% endblock %}
